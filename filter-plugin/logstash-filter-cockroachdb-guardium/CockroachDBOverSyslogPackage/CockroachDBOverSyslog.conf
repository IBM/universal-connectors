input {
 tcp {
      port => <PORT_NUMBER>
      type => "syslog-cockroachdb"
      dns_reverse_lookup_enabled => false
      ssl_enable => true
      # ssl_certificate_authorities => ["${SSL_DIR}/ca.pem"]
      ssl_cert => "${SSL_DIR}/tls.crt"
      ssl_key => "${SSL_DIR}/tls.key"
      ssl_verify => true
 }
}

filter {
  if [type] == "syslog-cockroachdb" {
    
    # Drop system-generated queries FIRST (before any parsing) - optimized for performance
    if [message] =~ /intExec=/ or
       [message] =~ /job=AUTO / or
       [message] =~ /User=node[,\s]/ or
       [message] =~ /ApplicationName=\$ internal/ or
       [message] =~ /ExecMode=exec-internal/ or
       [message] =~ /(crdb_internal\.|pg_catalog\.|information_schema\.|system\.(jobs|lease|sql_instances|job_info|statement_statistics|transaction_statistics|job_progress_history|reports_meta))/ {
      drop { }
    }

    # Drop CockroachDB configuration/informational messages that don't have JSON payloads
    if [message] =~ /\[config\]/ and [message] !~ /[=|]\{.*\}$/ {
      drop { }
    }

    # Extract timestamp, tags, and JSON from CockroachDB log format
    grok {
      match => {
        "message" => "[A-Z](?<log_date>\d{6})\s+(?<log_time>[\d:\.]+).*\[(?<log_tags>[^\]]+)\].*[=|](?<cockroach_json>\{.*\})$"
      }
    }

    # Extract client IP and port from log_tags
    if [log_tags] {
      grok {
        match => {
          "log_tags" => "client=%{IP:client_ip}:%{NUMBER:client_port}"
        }
      }
    }

    # Remove grok failure tags if parsing succeeded
    if [cockroach_json] {
      mutate {
        remove_tag => ["_grokparsefailure", "_grokparsefailure_sysloginput"]
      }
    }

    # Parse the CockroachDB JSON
    if [cockroach_json] {
      json {
        source => "cockroach_json"
        target => "cockroachdb"
      }

      # Add client IP and port to cockroachdb object
      if [client_ip] {
        mutate {
          add_field => {
            "[cockroachdb][ClientIP]" => "%{client_ip}"
            "[cockroachdb][ClientPort]" => "%{client_port}"
          }
        }
      }

      # Add server hostname from syslog
      if [host] {
        mutate {
          add_field => { "[cockroachdb][ServerHostname]" => "%{host}" }
        }
      }

      # Convert nanosecond timestamp to readable format
      if [cockroachdb][Timestamp] {
        ruby {
          code => "
            timestamp_ns = event.get('[cockroachdb][Timestamp]')
            timestamp_sec = timestamp_ns / 1_000_000_000.0
            event.set('[cockroachdb][TimestampReadable]', Time.at(timestamp_sec).utc.strftime('%Y-%m-%d %H:%M:%S.%6N UTC'))
          "
        }
      }
    }

    # Apply the Guardium filter (system queries already dropped early)
    if [cockroachdb] {
      cockroachdb_guardium_filter {}
    }

    # Clean up temporary fields
    mutate {
      remove_field => [
        "cockroach_json",
        "log_date",
        "log_time",
        "log_tags",
        "message"
      ]
    }
  }
}