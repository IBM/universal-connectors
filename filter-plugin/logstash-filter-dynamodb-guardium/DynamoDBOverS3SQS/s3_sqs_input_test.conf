input{
    generator {
        message => '{"Records":[{"eventVersion":"1.10","userIdentity":{"type":"AssumedRole","principalId":"AROAVBQDAZ24Z7RFEJOTC:Piyush.Desai@ibm.com","arn":"arn:aws:sts::346824953529:assumed-role/aws_gi_dev/Piyush.Desai@ibm.com","accountId":"346824953529","accessKeyId":"ASIAVBQDAZ243ETOMVXT","sessionContext":{"sessionIssuer":{"type":"Role","principalId":"AROAVBQDAZ24Z7RFEJOTC","arn":"arn:aws:iam::346824953529:role/aws_gi_dev","accountId":"346824953529","userName":"aws_gi_dev"},"attributes":{"creationDate":"2025-02-21T08:24:22Z","mfaAuthenticated":"false"}}},"eventTime":"2025-02-21T08:54:25Z","eventSource":"dynamodb.amazonaws.com","eventName":"Scan","awsRegion":"ap-south-1","sourceIPAddress":"223.233.85.226","userAgent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36","requestParameters":{"tableName":"TestDynamoDB","limit":1,"consistentRead":false},"responseElements":null,"requestID":"O964QI1DVR44ANSU51S3GAVUKVVV4KQNSO5AEMVJF66Q9ASUAAJG","eventID":"ada136ef-f5a4-4730-9fa9-5c6ea8fbe162","readOnly":true,"resources":[{"accountId":"346824953529","type":"AWS::DynamoDB::Table","ARN":"arn:aws:dynamodb:ap-south-1:346824953529:table/TestDynamoDB"}],"eventType":"AwsApiCall","apiVersion":"2012-08-10","managementEvent":false,"recipientAccountId":"346824953529","eventCategory":"Data","tlsDetails":{"tlsVersion":"TLSv1.3","cipherSuite":"TLS_AES_128_GCM_SHA256","clientProvidedHostHeader":"dynamodb.ap-south-1.amazonaws.com"},"sessionCredentialFromConsole":"true"},{"eventVersion":"1.10","userIdentity":{"type":"AssumedRole","principalId":"AROAVBQDAZ24Z7RFEJOTC:Piyush.Desai@ibm.com","arn":"arn:aws:sts::346824953529:assumed-role/aws_gi_dev/Piyush.Desai@ibm.com","accountId":"346824953529","accessKeyId":"ASIAVBQDAZ24VP27NMCD","sessionContext":{"sessionIssuer":{"type":"Role","principalId":"AROAVBQDAZ24Z7RFEJOTC","arn":"arn:aws:iam::346824953529:role/aws_gi_dev","accountId":"346824953529","userName":"aws_gi_dev"},"attributes":{"creationDate":"2025-02-21T08:24:22Z","mfaAuthenticated":"false"}}},"eventTime":"2025-02-21T08:58:54Z","eventSource":"dynamodb.amazonaws.com","eventName":"PutItem","awsRegion":"ap-south-1","sourceIPAddress":"3.110.235.167","userAgent":"aws-cli/2.24.5 md/awscrt#0.23.8 ua/2.0 os/linux#6.1.127-135.201.amzn2023.x86_64 md/arch#x86_64 lang/python#3.12.6 md/pyimpl#CPython exec-env/CloudShell cfg/retry-mode#standard md/installer#exe md/distrib#amzn.2023 md/prompt#off md/command#dynamodb.put-item","requestParameters":{"tableName":"TestDynamoDB","key":{"TestDynamoDB_":"Item001"},"items":["Attribute3","Attribute2","Attribute1","TestDynamoDB_"]},"responseElements":null,"requestID":"CI4GH3IR1MQS4M9JNMI0RNKE17VV4KQNSO5AEMVJF66Q9ASUAAJG","eventID":"0934bf16-d19a-4a6a-8509-d401780529f2","readOnly":false,"resources":[{"accountId":"346824953529","type":"AWS::DynamoDB::Table","ARN":"arn:aws:dynamodb:ap-south-1:346824953529:table/TestDynamoDB"}],"eventType":"AwsApiCall","apiVersion":"2012-08-10","managementEvent":false,"recipientAccountId":"346824953529","eventCategory":"Data","tlsDetails":{"tlsVersion":"TLSv1.3","cipherSuite":"TLS_AES_256_GCM_SHA384","clientProvidedHostHeader":"dynamodb.ap-south-1.amazonaws.com"},"sessionCredentialFromConsole":"true"},{"eventVersion":"1.10","userIdentity":{"type":"AssumedRole","principalId":"AROAVBQDAZ24Z7RFEJOTC:Piyush.Desai@ibm.com","arn":"arn:aws:sts::346824953529:assumed-role/aws_gi_dev/Piyush.Desai@ibm.com","accountId":"346824953529","accessKeyId":"ASIAVBQDAZ24VP27NMCD","sessionContext":{"sessionIssuer":{"type":"Role","principalId":"AROAVBQDAZ24Z7RFEJOTC","arn":"arn:aws:iam::346824953529:role/aws_gi_dev","accountId":"346824953529","userName":"aws_gi_dev"},"attributes":{"creationDate":"2025-02-21T08:24:22Z","mfaAuthenticated":"false"}}},"eventTime":"2025-02-21T08:59:06Z","eventSource":"dynamodb.amazonaws.com","eventName":"GetItem","awsRegion":"ap-south-1","sourceIPAddress":"3.110.235.167","userAgent":"aws-cli/2.24.5 md/awscrt#0.23.8 ua/2.0 os/linux#6.1.127-135.201.amzn2023.x86_64 md/arch#x86_64 lang/python#3.12.6 md/pyimpl#CPython exec-env/CloudShell cfg/retry-mode#standard md/installer#exe md/distrib#amzn.2023 md/prompt#off md/command#dynamodb.get-item","requestParameters":{"tableName":"TestDynamoDB","key":{"TestDynamoDB_":"Item001"}},"responseElements":null,"requestID":"SJP2K5SQH0VGRSI8UA7C1HTHP7VV4KQNSO5AEMVJF66Q9ASUAAJG","eventID":"8c945250-068f-4fd1-856c-55df7d9f3418","readOnly":true,"resources":[{"accountId":"346824953529","type":"AWS::DynamoDB::Table","ARN":"arn:aws:dynamodb:ap-south-1:346824953529:table/TestDynamoDB"}],"eventType":"AwsApiCall","apiVersion":"2012-08-10","managementEvent":false,"recipientAccountId":"346824953529","eventCategory":"Data","tlsDetails":{"tlsVersion":"TLSv1.3","cipherSuite":"TLS_AES_256_GCM_SHA384","clientProvidedHostHeader":"dynamodb.ap-south-1.amazonaws.com"},"sessionCredentialFromConsole":"true"}]}'
        add_field => { "include_account_in_host" => "true" }
        count => 1
        type => "S3SQS"
    }
}

filter {
  if [type] == 'S3SQS' and [message] {
    
    json {
      source => "message"
      target => "parsed_message"
    }

    # Drop event if parsed_message does not contain "Records"
    if ![parsed_message][Records] {
      drop {}
    }

    ruby {
      code => '
        parsed_message = event.get("parsed_message")
        if parsed_message && parsed_message["Records"].is_a?(Array)
          parsed_message["Records"].each do |record|
            record["type"] = event.get("type")
            record["timestamp"] = event.get("timestamp") || Time.now.to_i
            record["fileKey"] = event.get("fileKey") || "unknown"
            record["@version"] = event.get("@version")
            record["@timestamp"] = event.get("@timestamp")
          end
          event.set("message", parsed_message["Records"].to_json)
        else
          event.tag("json_parse_error")
        end
      '
    }

    dynamodb_guardium_plugin_filter {}

    prune { whitelist_names => [ "GuardRecord" ] }
  }
}



output {
  stdout { codec => rubydebug }
}
